<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refuah Berurah - Production Ready</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <script>
        // Custom Tailwind theme for a more modern look
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { // Replaces blue
                            DEFAULT: '#0ea5e9',
                            '50': '#f0f9ff', '100': '#e0f2fe', '200': '#bae6fd',
                            '300': '#7dd3fc', '400': '#38bdf8', '500': '#0ea5e9',
                            '600': '#0284c7', '700': '#0369a1', '800': '#075985',
                            '900': '#0c4a6e'
                        },
                        secondary: { // Replaces green
                           DEFAULT: '#14b8a6',
                           '50': '#f0fdfa', '100': '#ccfbf1', '200': '#99f6e4',
                           '300': '#5eead4', '400': '#2dd4bf', '500': '#14b8a6',
                           '600': '#0d9488', '700': '#0f766e', '800': '#115e59',
                           '900': '#134e4a'
                        },
                        // Using slate for a cooler gray palette
                        slate: { '50': '#f8fafc', '100': '#f1f5f9', '200': '#e2e8f0', '300': '#cbd5e1', '400': '#94a3b8', '500': '#64748b', '600': '#475569', '700': '#334155', '800': '#1e293b', '900': '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        /* Global Styles */
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }

        /* Input Field Styles */
        .input { margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; background-color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .input:focus { outline: none; --tw-ring-color: #38bdf8; box-shadow: 0 0 0 2px var(--tw-ring-color); border-color: #38bdf8; }

        /* Loader Styles */
        .loader { width: 48px; height: 48px; border: 5px solid #e2e8f0; border-bottom-color: #0ea5e9; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-overlay { position: absolute; inset: 0; background-color: rgba(248, 250, 252, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10; }
        #initial-loader { display: flex; align-items: center; justify-content: center; min-height: 100vh; }

        /* Mobile Menu Animation */
        #mobile-menu { transform: translateX(-100%); }
        #mobile-menu.open { transform: translateX(0); }

        /* Button Styles */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: all 0.2s; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1); }
        .btn-primary { background-color: #0ea5e9; color: white; } .btn-primary:hover { background-color: #0284c7; }
        .btn-secondary { background-color: #14b8a6; color: white; } .btn-secondary:hover { background-color: #0d9488; }
        .btn-danger { background-color: #ef4444; color: white; } .btn-danger:hover { background-color: #dc2626; }
        .btn-light { background-color: #e2e8f0; color: #334155; } .btn-light:hover { background-color: #cbd5e1; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }

        /* Spinner inside Button */
        @keyframes spinner-rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner-inside-button { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spinner-rotation 0.8s linear infinite; }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 100;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .notification.show { opacity: 1; transform: translateY(0); }
        .notification.success { background-color: #14b8a6; }
        .notification.error { background-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-100 text-slate-700">
    <div id="notification-area"></div>
    <div id="app">
        <div id="initial-loader">
            <div class="text-center">
                <img src="https://raw.githubusercontent.com/BinyanShalem/ShalemBinyan/refs/heads/main/output-onlinetools.png" alt="Refuah Berurah Logo" class="h-12 w-auto mx-auto">
                <p class="mt-4 text-slate-500 animate-pulse">Connecting to services...</p>
            </div>
        </div>
    </div>
    <div id="modal-container">
    </div>

    <script>
        // =================================================================================
        // API Keys & Configuration
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDMAZ_HJ7JIqNHxYAXcOgpVZN4tnLwWUWA",
            authDomain: "refuahberur.firebaseapp.com",
            projectId: "refuahberur",
            storageBucket: "refuahberur.appspot.com",
            messagingSenderId: "345766239268",
            appId: "1:345766239268:web:9b7fcf947760b5ea53ccb1",
            measurementId: "G-0XREW3ZGYZ"
        };

        // GoFile API Token
        const GOFILE_API_KEY = 'KTlhggWrtt6D84BXJ1nqj56ZbutZeJCR'; 
        const GOFILE_ROOT_FOLDER_NAME = 'refuah berurah';

        // =================================================================================
        // --- App State (Global variables for Firebase and current user) ---
        let app, auth, db, userId;
        const appId = 'refuah-berurah-prod';
        
        // =================================================================================
        // --- GLOBAL UTILITY HELPERS ---
        
        // --- GLOBAL NOTIFICATION HELPER ---
        window.showNotification = (message, type = 'success') => {
            const container = document.getElementById('notification-area');
            if (!container) return;
            const notifId = `notif-${Date.now()}`;
            const notifDiv = document.createElement('div');
            notifDiv.id = notifId;
            notifDiv.className = `notification ${type}`;
            notifDiv.innerText = message;
            container.appendChild(notifDiv);

            setTimeout(() => { notifDiv.classList.add('show'); }, 10);
            setTimeout(() => {
                notifDiv.classList.remove('show');
                notifDiv.addEventListener('transitionend', () => notifDiv.remove());
            }, 3000);
        };

        // --- GLOBAL MODAL HELPERS ---
        window.showConfirmModal = (title, message, onConfirm) => {
            const modal = document.getElementById('confirm-modal');
            if (!modal) return;
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerText = message;
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true); // Clone to remove existing event listeners
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.onclick = () => { onConfirm(); modal.classList.add('hidden'); };
            document.getElementById('cancel-confirm-btn').onclick = () => { modal.classList.add('hidden'); };
            modal.classList.remove('hidden');
            if (window.lucide) window.lucide.createIcons({ nodes: [modal.querySelector('[data-lucide]')] });
        };

        // =================================================================================
        // --- ROUTER: Handles navigation within the single-page application ---
        const AppRouter = {
            routes: {},
            currentRoute: '',
            init() {
                window.addEventListener('hashchange', () => this.handleRouteChange());
            },
            addRoute(route, component) { this.routes[route] = component; },
            handleRouteChange() {
                const hash = window.location.hash.slice(1) || '/';
                // Optimization: prevent re-rendering if the route is the same, unless it's a patient detail route
                if (this.currentRoute === hash && !hash.startsWith('/patient/')) return; 
                
                const routeParts = hash.split('/');
                let component;
                let params = {};
                
                // Handle dynamic routes like /patient/:id
                if (routeParts[1] === 'patient' && routeParts.length === 3) {
                    component = this.routes['/patient/:id'];
                    params = { id: routeParts[2] };
                } else {
                    component = this.routes[hash];
                }

                if (component) {
                    this.currentRoute = hash;
                    document.getElementById('app').innerHTML = component.render(params);
                    // Render modals from the component, if it has any (e.g., PatientDetailComponent)
                    document.getElementById('modal-container').innerHTML = component.renderModals ? component.renderModals() : '';
                    if (component.postRender) component.postRender(params);
                } else {
                    // Default to dashboard if route not found
                    window.location.hash = '/dashboard'; 
                }
            },
            navigate(path) { window.location.hash = path; }
        };

        // =================================================================================
        // --- Firestore Database Layer ---
        // FirestoreDB will use the globally defined 'db', 'appId', and 'userId'
        const FirestoreDB = {
            getPatients: (callback) => db.collection(`artifacts/${appId}/users/${userId}/patients`).onSnapshot(callback),
            addPatient: (patientData) => db.collection(`artifacts/${appId}/users/${userId}/patients`).add(patientData),
            savePatient: (patientId, patientData) => db.collection(`artifacts/${appId}/users/${userId}/patients`).doc(patientId).set(patientData, { merge: true }),
            deletePatient: (patientId) => db.collection(`artifacts/${appId}/users/${userId}/patients`).doc(patientId).delete(),
            
            getResources: (callback) => db.collection(`artifacts/${appId}/users/${userId}/resources`).onSnapshot(callback),
            addResource: (resourceData) => db.collection(`artifacts/${appId}/users/${userId}/resources`).add(resourceData),
            deleteResource: (resourceId) => db.collection(`artifacts/${appId}/users/${userId}/resources`).doc(resourceId).delete(),
        };

        // =================================================================================
        // --- UI COMPONENTS ---

        // --- Layout Component (Sidebar, Header, Confirmation Modal) ---
        const Layout = {
            render(content, activeLink) {
                const navLinks = [
                    { path: '/dashboard', icon: 'layout-dashboard', label: 'Dashboard' },
                    { path: '/patients', icon: 'users', label: 'Patients' },
                    { path: '/resources', icon: 'book-marked', label: 'Resources' },
                ];
                const navLinksHtml = navLinks.map(link => `<li><a href="#${link.path}" class="flex items-center p-3 rounded-lg text-slate-600 hover:bg-primary-50 hover:text-primary-600 font-medium transition-all ${activeLink === link.label ? 'bg-primary-100 text-primary-700 font-semibold' : ''}"><svg class="w-5 h-5 mr-3" data-lucide="${link.icon}"></svg>${link.label}</a></li>`).join('');

                return `
                    <div class="min-h-screen flex">
                        <nav class="hidden md:flex w-64 bg-white border-r border-gray-200 flex-shrink-0 flex-col">
                            <div class="h-16 flex items-center justify-center border-b border-gray-200 p-4"><img src="https://raw.githubusercontent.com/BinyanShalem/ShalemBinyan/refs/heads/main/logosss.png" alt="Refuah Berurah Logo" class="h-10 w-auto"></div>
                            <div class="p-4 flex-grow"><ul>${navLinksHtml}</ul></div>
                            <div class="p-4 border-t border-gray-200"><a href="#" id="logout-btn" class="flex items-center p-3 rounded-lg text-gray-600 hover:bg-red-50 hover:text-red-600 transition-all"><svg class="w-5 h-5 mr-3" data-lucide="log-out"></svg>Logout</a></div>
                        </nav>
                        
                        <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
                        <nav id="mobile-menu" class="fixed top-0 left-0 h-full w-64 bg-white z-40 flex flex-col transition-all md:hidden">
                             <div class="h-16 flex items-center justify-between border-b border-gray-200 px-4">
                                 <img src="https://raw.githubusercontent.com/BinyanShalem/ShalemBinyan/refs/heads/main/logosss.png" alt="Refuah Berurah Logo" class="h-8 w-auto">
                                 <button id="close-mobile-menu-btn" class="p-2"><svg class="w-6 h-6" data-lucide="x"></svg></button>
                             </div>
                            <div class="p-4 flex-grow"><ul class="space-y-2">${navLinksHtml}</ul></div>
                            <div class="p-4 border-t border-slate-200"><a href="#" id="mobile-logout-btn" class="flex items-center p-3 rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-600 transition-all"><svg class="w-5 h-5 mr-3" data-lucide="log-out"></svg>Logout</a></div>
                        </nav>

                        <div class="flex-1 flex flex-col">
                            <header class="md:hidden h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4">
                                <button id="open-mobile-menu-btn" class="p-2"><svg class="w-6 h-6" data-lucide="menu"></svg></button>
                                <img src="https://raw.githubusercontent.com/BinyanShalem/ShalemBinyan/refs/heads/main/logosss.png" alt="Refuah Berurah Logo" class="h-8 w-auto">
                                <div class="w-8"></div> </header>
                            <main class="flex-1 bg-slate-100 p-4 sm:p-6 lg:p-8 overflow-y-auto relative">${content}</main>
                        </div>
                    </div>
                    ${this.renderConfirmModal()}
                `;
            },
            renderConfirmModal() {
                return `
                    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center transform transition-all">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" data-lucide="alert-triangle"></svg></div>
                            <h3 id="confirm-title" class="text-lg font-bold text-slate-800 mt-3">Delete Item</h3>
                            <p id="confirm-message" class="text-sm text-slate-500 mt-2 mb-4">Are you sure? This action cannot be undone.</p>
                            <div class="flex justify-center space-x-3">
                                <button id="cancel-confirm-btn" class="btn btn-light w-24">Cancel</button>
                                <button id="confirm-action-btn" class="btn btn-danger w-24">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            },
            postRender() {
                if (window.lucide) window.lucide.createIcons();
                
                // Logout event listeners
                const logout = async (e) => { e.preventDefault(); await auth.signOut(); };
                document.getElementById('logout-btn')?.addEventListener('click', logout);
                document.getElementById('mobile-logout-btn')?.addEventListener('click', logout);
                
                // Mobile menu logic
                const mobileMenu = document.getElementById('mobile-menu');
                const overlay = document.getElementById('mobile-menu-overlay');
                const openBtn = document.getElementById('open-mobile-menu-btn');
                const closeBtn = document.getElementById('close-mobile-menu-btn');

                const openMenu = () => {
                    mobileMenu.classList.add('open');
                    overlay.classList.remove('hidden');
                };
                const closeMenu = () => {
                    mobileMenu.classList.remove('open');
                    overlay.classList.add('hidden');
                };

                openBtn?.addEventListener('click', openMenu);
                closeBtn?.addEventListener('click', closeMenu);
                overlay?.addEventListener('click', closeMenu);
            }
        };

        // --- Login Component ---
        const LoginComponent = {
            render() {
                return `
                    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-100 to-primary-100 p-4">
                        <div class="w-full max-w-md">
                            <div id="auth-container" class="bg-white/80 backdrop-blur-sm rounded-xl shadow-2xl shadow-slate-300/50 p-8 space-y-6">
                            </div>
                        </div>
                    </div>
                `;
            },
            renderLoginForm(error = '') {
                return `
                    <div class="text-center">
                        <img src="https://raw.githubusercontent.com/BinyanShalem/ShalemBinyan/refs/heads/main/logosss.png" alt="Refuah Berurah Logo" class="h-12 w-auto mx-auto">
                        <p class="mt-2 text-gray-500">Sign in to your secure medical hub</p>
                    </div>
                    <form id="login-form" class="space-y-4 pt-6">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-slate-700">Email address</label>
                            <input type="email" id="login-email" name="email" autocomplete="email" required class="input">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-slate-700">Password</label>
                            <input type="password" id="login-password" name="password" autocomplete="current-password" required class="input">
                        </div>
                        ${error ? `<p class="text-sm text-red-600">${error}</p>` : ''}
                        <div>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-lg shadow-md text-sm font-semibold text-white bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 transition-all transform hover:scale-105">
                                Sign in
                            </button>
                        </div>
                    </form>
                    <p class="text-center text-sm text-slate-500 pt-4">
                        No account? <a href="#" id="show-signup" class="font-medium text-primary-600 hover:text-primary-500">Create one</a>
                    </p>
                `;
            },
            renderSignupForm(error = '') {
                   return `
                    <div class="text-center">
                           <img src="https://raw.githubusercontent.com/BinyanShalem/ShalemBinyan/refs/heads/main/logosss.png" alt="Refuah Berurah Logo" class="h-12 w-auto mx-auto">
                         <h2 class="mt-6 text-2xl font-bold tracking-tight text-slate-900">Create your account</h2>
                         <p class="mt-2 text-slate-600">Get started with your secure hub</p>
                    </div>
                    <form id="signup-form" class="space-y-4 pt-6">
                        <div>
                            <label for="signup-email" class="block text-sm font-medium text-slate-700">Email address</label>
                            <input type="email" id="signup-email" name="email" autocomplete="email" required class="input">
                        </div>
                        <div>
                            <label for="signup-password" class="block text-sm font-medium text-slate-700">Password</label>
                            <input type="password" id="signup-password" name="password" autocomplete="new-password" required class="input">
                        </div>
                           ${error ? `<p class="text-sm text-red-600">${error}</p>` : ''}
                        <div>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-lg shadow-md text-sm font-semibold text-white bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 transition-all transform hover:scale-105">
                                Create Account
                            </button>
                        </div>
                    </form>
                    <p class="text-center text-sm text-slate-500 pt-4">
                        Already have an account? <a href="#" id="show-login" class="font-medium text-primary-600 hover:text-primary-500">Sign in</a>
                    </p>
                `;
            },
            postRender() {
                const authContainer = document.getElementById('auth-container');
                
                const showLogin = (error = '') => {
                    if (!authContainer) return;
                    authContainer.innerHTML = this.renderLoginForm(error);
                    document.getElementById('login-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const email = e.target.email.value;
                        const password = e.target.password.value;
                        try {
                            await auth.signInWithEmailAndPassword(email, password);
                        } catch (err) {
                            showLogin(err.message);
                        }
                    });
                    document.getElementById('show-signup').addEventListener('click', (e) => {
                        e.preventDefault();
                        showSignup();
                    });
                };
                const showSignup = (error = '') => {
                    if (!authContainer) return;
                    authContainer.innerHTML = this.renderSignupForm(error);
                    document.getElementById('signup-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const email = e.target.email.value;
                        const password = e.target.password.value;
                        try {
                            await auth.createUserWithEmailAndPassword(email, password);
                        } catch (err) {
                            showSignup(err.message);
                        }
                    });
                           document.getElementById('show-login').addEventListener('click', (e) => {
                                e.preventDefault();
                                showLogin();
                            });
                };
                showLogin(); // Show login form by default
            }
        };

        // --- Dashboard Component ---
        const DashboardComponent = {
            render() { return Layout.render(`<div id="dashboard-content"><div class="loading-overlay"><div class="loader"></div></div></div>`, 'Dashboard'); },
            async postRender() {
                Layout.postRender();
                FirestoreDB.getPatients(patientQuerySnapshot => {
                    const patientCount = patientQuerySnapshot.size;
                    const countEl = document.querySelector('#patient-count');
                    if (countEl) countEl.innerText = patientCount;
                });
                FirestoreDB.getResources(resourceQuerySnapshot => {
                    const resourceCount = resourceQuerySnapshot.size;
                    const countEl = document.querySelector('#resource-count');
                    if(countEl) countEl.innerText = resourceCount;
                });
                document.getElementById('dashboard-content').innerHTML = `
                    <div class="space-y-8">
                        <div><h2 class="text-3xl font-bold tracking-tight text-slate-900">Dashboard</h2><p class="mt-1 text-slate-500">Welcome back! Here's a real-time summary of your workspace.</p></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-400 flex items-center"><div class="p-3 rounded-full bg-primary-100 text-primary-600"><svg class="w-7 h-7" data-lucide="users"></svg></div><div class="ml-4"><p class="text-sm font-medium text-slate-500">Total Patients</p><p id="patient-count" class="text-3xl font-bold text-slate-800">0</p></div></div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-secondary-400 flex items-center"><div class="p-3 rounded-full bg-secondary-100 text-secondary-600"><svg class="w-7 h-7" data-lucide="book-marked"></svg></div><div class="ml-4"><p class="text-sm font-medium text-slate-500">Total Resources</p><p id="resource-count" class="text-2xl font-bold text-slate-800">0</p></div></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                            <h3 class="text-lg font-semibold text-slate-800">Quick Actions</h3>
                            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <a href="#/patients" class="flex items-center justify-center p-4 bg-primary-50 text-primary-700 font-semibold rounded-lg hover:bg-primary-100 transition-all"><svg class="w-5 h-5 mr-2" data-lucide="user-plus"></svg>Add New Patient</a>
                                <a href="#/resources" class="flex items-center justify-center p-4 bg-secondary-50 text-secondary-700 font-semibold rounded-lg hover:bg-secondary-100 transition-all"><svg class="w-5 h-5 mr-2" data-lucide="plus-circle"></svg>Add New Resource</a>
                            </div>
                        </div>
                    </div>`;
                if(window.lucide) window.lucide.createIcons();
            }
        };

        // --- Patients List Component ---
        const PatientsComponent = {
            render() { return Layout.render(`<div id="patients-container"><div class="loading-overlay"><div class="loader"></div></div></div>`, 'Patients'); },
            renderModals() {
                return `
                    <div id="patient-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg"><h3 class="text-2xl font-bold mb-4 text-slate-800">Add New Patient</h3><form id="patient-form" class="space-y-4">
                            <div><label for="name" class="block text-sm font-medium text-slate-700">Full Name</label><input type="text" id="name" required class="input"></div>
                            <div><label for="dob" class="block text-sm font-medium text-slate-700">Date of Birth</label><input type="date" id="dob" required class="input"></div>
                            <div><label for="contact" class="block text-sm font-medium text-slate-700">Contact Info</label><input type="text" id="contact" required class="input"></div>
                            <div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-patient-btn" class="btn btn-light">Cancel</button><button type="submit" class="btn btn-primary">Save Patient</button></div>
                        </form></div>
                    </div>`;
            },
            postRender() {
                Layout.postRender();
                const container = document.getElementById('patients-container');
                if (!container) return;

                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div><h2 class="text-3xl font-bold tracking-tight text-slate-900">Patients</h2><p class="mt-1 text-slate-500">Manage your patient records.</p></div>
                            <button id="add-patient-btn" class="btn btn-primary w-full sm:w-auto"><svg class="w-5 h-5 mr-2" data-lucide="user-plus"></svg>Add Patient</button>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
                            <div class="p-4 border-b border-slate-200"><input type="text" id="search-patient" placeholder="Search patients by name..." class="input w-full"></div>
                            <div id="patient-list" class="divide-y divide-slate-200"><div class="p-6 text-center text-slate-500">Loading patients...</div></div>
                        </div>
                    </div>`;

                const modal = document.getElementById('patient-modal');
                const form = document.getElementById('patient-form');
                if (modal && form) {
                    document.getElementById('add-patient-btn').addEventListener('click', () => modal.classList.remove('hidden'));
                    document.getElementById('cancel-patient-btn').addEventListener('click', () => modal.classList.add('hidden'));
                    
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        const saveButton = form.querySelector('button[type="submit"]');
                        const originalButtonText = saveButton.innerHTML;
                        saveButton.disabled = true;
                        saveButton.innerHTML = `<div class="spinner-inside-button"></div>`;

                        try {
                            await FirestoreDB.addPatient({ 
                                name: form.name.value, 
                                dob: form.dob.value, 
                                contact: form.contact.value, 
                                mypageLink: '', 
                                linkedResourceIds: [],
                                createdAt: new Date().toISOString()
                            });
                            modal.classList.add('hidden');
                            form.reset();
                            window.showNotification('Patient added successfully!', 'success');
                        } catch (error) {
                            console.error("Error adding patient:", error);
                            window.showNotification(`Error: ${error.message}`, 'error');
                        } finally {
                            saveButton.disabled = false;
                            saveButton.innerHTML = originalButtonText;
                        }
                    };
                }

                let patientDocs = []; 
                FirestoreDB.getPatients(querySnapshot => {
                    patientDocs = querySnapshot.docs;
                    const searchInput = document.getElementById('search-patient');
                    const currentFilter = searchInput ? searchInput.value : '';
                    this.renderPatientList(patientDocs, currentFilter);
                });

                document.getElementById('search-patient')?.addEventListener('input', (e) => {
                    this.renderPatientList(patientDocs, e.target.value);
                });

                if(window.lucide) window.lucide.createIcons();
            },
            renderPatientList(patients, filter = '') {
                const filteredPatients = patients.filter(p => p.data().name.toLowerCase().includes(filter.toLowerCase()));
                const listEl = document.getElementById('patient-list');
                if (!listEl) return;
                listEl.innerHTML = filteredPatients.length === 0 ? `<p class="p-6 text-center text-slate-500">No patients found.</p>` : filteredPatients.map(doc => {
                    const patient = doc.data();
                    return `<div class="p-4 flex items-center justify-between hover:bg-primary-50/50 transition-colors duration-150">
                        <a href="#/patient/${doc.id}" class="flex-1 min-w-0"><p class="font-semibold text-primary-700 hover:text-primary-800 truncate">${patient.name}</p><p class="text-sm text-slate-500">DOB: ${patient.dob} | Contact: ${patient.contact}</p></a>
                        <button data-id="${doc.id}" data-name="${patient.name}" class="delete-patient-btn text-slate-400 hover:text-red-500 p-2 rounded-full flex-shrink-0 ml-4"><svg class="w-5 h-5" data-lucide="trash-2"></svg></button>
                    </div>`
                }).join('');
                document.querySelectorAll('.delete-patient-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const patientId = btn.dataset.id;
                    const patientName = btn.dataset.name;
                    window.showConfirmModal('Delete Patient?', `Are you sure you want to permanently delete ${patientName}? This action cannot be undone.`, () => FirestoreDB.deletePatient(patientId));
                }));
                if (window.lucide) window.lucide.createIcons();
            },
        };

        // --- Patient Detail Component (Notes, Files, Credentials, Linked Resources) ---
        const PatientDetailComponent = {
            activeTab: 'notes', // Default active tab
            render() { return Layout.render(`<div id="patient-detail-container"><div class="loading-overlay"><div class="loader"></div></div></div>`, 'Patients'); },
            renderModals() {
                // Modals specific to PatientDetail and shared (like GoFileUploader, ResourcesComponent modals)
                return `
                    <div id="credential-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg"><h3 class="text-2xl font-bold mb-4 text-slate-800">Add Credential</h3><form id="credential-form" class="space-y-4">
                            <div><label for="service" class="block text-sm font-medium text-slate-700">Service/System Name</label><input type="text" id="service" required class="input"></div>
                            <div><label for="link" class="block text-sm font-medium text-slate-700">URL/Link</label><input type="url" id="link" required class="input"></div>
                            <div><label for="username" class="block text-sm font-medium text-slate-700">Username</label><input type="text" id="username" required class="input"></div>
                            <div><label for="passwordRef" class="block text-sm font-medium text-slate-700">Password Location</label><input type="text" id="passwordRef" placeholder="e.g., Stored in 1Password" required class="input"></div>
                            <p class="text-xs text-red-600">Reminder: Do not store actual passwords here.</p>
                            <div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-cred-btn" class="btn btn-light">Cancel</button><button type="submit" class="btn bg-purple-600 hover:bg-purple-700 text-white">Save</button></div>
                        </form></div>
                    </div>
                    <div id="link-resource-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl flex flex-col" style="max-height: 90vh;"><h3 class="text-2xl font-bold mb-4 text-slate-800">Link Resources</h3>
                            <div id="resource-link-list" class="flex-grow overflow-y-auto border-t border-b border-slate-200 mb-4 divide-y divide-slate-200"></div>
                            <div class="flex justify-end space-x-3 mt-4"><button type="button" id="cancel-link-resource-btn" class="btn btn-light">Cancel</button><button type="button" id="save-link-resource-btn" class="btn btn-primary">Save Links</button></div>
                        </div>
                    </div>
                    ${GoFileUploader.renderModal()}
                    ${ResourcesComponent.renderModals(true)} `;
            },
            postRender(params) {
                Layout.postRender();
                const container = document.getElementById('patient-detail-container');
                
                // Real-time listener for patient data
                db.collection(`artifacts/${appId}/users/${userId}/patients`).doc(params.id).onSnapshot((patientDoc) => {
                    if (!container || !patientDoc.exists) {
                        if (container) container.innerHTML = `<p>Patient not found.</p>`;
                        return;
                    }
                    const patient = { id: patientDoc.id, ...patientDoc.data() };
                    
                    const tabContentEl = document.getElementById('tab-content');
                    const scrollPos = tabContentEl ? tabContentEl.scrollTop : 0; // Preserve scroll position
                    container.innerHTML = `
                        <div class="space-y-6">
                            <div>
                                <a href="#/patients" class="flex items-center text-sm text-primary-600 hover:underline mb-4 font-medium"><svg class="w-4 h-4 mr-1" data-lucide="arrow-left"></svg>Back to Patients</a>
                                <h2 class="text-3xl font-bold tracking-tight text-slate-900">${patient.name}</h2>
                                <p class="mt-1 text-slate-500">DOB: ${patient.dob} | Contact: ${patient.contact}</p>
                            </div>
                            <div class="border-b border-slate-200"><nav class="-mb-px flex flex-wrap gap-x-8 gap-y-2" id="patient-tabs">
                                <a href="#" data-tab="notes" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Notes</a>
                                <a href="#" data-tab="files" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Files</a>
                                <a href="#" data-tab="credentials" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Chart Links & Credentials</a>
                                <a href="#" data-tab="links" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Links & Resources</a>
                            </nav></div>
                            <div id="tab-content" class="overflow-y-auto"></div>
                        </div>`;
                    
                    this.switchTab(this.activeTab, patient); // Re-render content for the active tab
                    
                    const newTabContentEl = document.getElementById('tab-content');
                    if (newTabContentEl) newTabContentEl.scrollTop = scrollPos; // Restore scroll position
                    document.querySelectorAll('.tab-link').forEach(link => link.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        this.activeTab = e.target.dataset.tab;
                        this.switchTab(this.activeTab, patient); 
                    }));
                    if(window.lucide) window.lucide.createIcons();
                });
                
                // Setup the resource modal for patient linking, ensuring it's ready
                ResourcesComponent.setupModal("resource-modal-patient");
            },
            switchTab(tabName, patient) {
                const tabContent = document.getElementById('tab-content');
                if (!tabContent) return;
                document.querySelectorAll('.tab-link').forEach(link => {
                    const isSelected = link.dataset.tab === tabName;
                    link.classList.toggle('border-primary-500', isSelected);
                    link.classList.toggle('text-primary-600', isSelected);
                    link.classList.toggle('border-transparent', !isSelected);
                    link.classList.toggle('text-slate-500', !isSelected);
                    link.classList.toggle('hover:text-slate-700', !isSelected);
                    link.classList.toggle('hover:border-slate-300', !isSelected);
                });
                if (tabName === 'notes') {
                    tabContent.innerHTML = `<div class="bg-white rounded-xl shadow-lg border border-slate-200"><div class="p-4"><form id="note-form"><textarea id="note-text" placeholder="Add a new note..." required class="w-full p-2 border border-slate-300 rounded-md focus:ring-primary-500 focus:border-primary-500"></textarea><button type="submit" class="mt-2 btn btn-primary text-sm">Add Note</button></form></div><div class="divide-y divide-slate-200">${(patient.notes || []).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(note => `<div class="p-4"><p class="text-slate-800">${note.text.replace(/\n/g, '<br>')}</p><p class="text-xs text-slate-400 mt-2">${new Date(note.timestamp).toLocaleString()}</p></div>`).join('') || '<p class="p-4 text-slate-500">No notes yet.</p>'}</div></div>`;
                    document.getElementById('note-form').addEventListener('submit', async (e) => { e.preventDefault(); const textEl = document.getElementById('note-text'); if (textEl.value.trim()) { const updatedNotes = [...(patient.notes || []), { text: textEl.value, timestamp: new Date().toISOString() }]; await FirestoreDB.savePatient(patient.id, { notes: updatedNotes }); } });
                } else if (tabName === 'files') {
                    tabContent.innerHTML = `
                        <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                            <div class="p-4 border-b border-slate-200 space-y-3">
                                <h4 class="text-lg font-semibold text-slate-800">Upload Files</h4>
                                <button id="gofile-upload-btn" class="btn btn-secondary"><svg class="w-5 h-5 mr-2" data-lucide="upload-cloud"></svg>Upload File</button>
                            </div>
                            <div class="divide-y divide-slate-200">${(patient.files || []).map((file, index) => `
                                <div class="p-4 hover:bg-slate-50/50">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center min-w-0 cursor-pointer view-file-link" data-url="${file.url}">
                                            <svg class="w-8 h-8 text-indigo-500 mr-4 flex-shrink-0" data-lucide="file-text"></svg>
                                            <div class="min-w-0">
                                                <p class="font-medium text-slate-800 truncate">${file.name}</p>
                                                <p class="text-sm text-slate-500">Stored via GoFile</p>
                                            </div>
                                        </div>
                                        <div class="relative">
                                            <button class="file-actions-btn p-2 rounded-full hover:bg-slate-200" data-index="${index}">
                                                <svg class="w-5 h-5 text-slate-600" data-lucide="more-vertical"></svg>
                                            </button>
                                            <div id="file-actions-dropdown-${index}" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border border-slate-200">
                                                <a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 view-file-link" data-url="${file.url}">View File</a>
                                                <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-slate-100 delete-file-link" data-index="${index}">Delete File</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 pl-12">
                                        <h5 class="text-sm font-semibold text-slate-700">Notes:</h5>
                                        <div class="text-sm text-slate-600 mt-1 space-y-1">
                                            ${(file.notes || []).map(note => `<p class="p-2 bg-slate-100 rounded">${note}</p>`).join('') || '<p class="text-xs text-slate-400">No notes for this file.</p>'}
                                        </div>
                                        <form class="add-file-note-form mt-2" data-file-index="${index}">
                                            <textarea class="input text-sm p-1.5" placeholder="Add a note..."></textarea>
                                            <button type="submit" class="mt-1 bg-slate-200 text-slate-700 px-3 py-1 rounded text-xs hover:bg-slate-300 font-medium">Save Note</button>
                                        </form>
                                    </div>
                                </div>`).join('') || '<p class="p-4 text-center text-slate-500">No files uploaded.</p>'}
                            </div>
                        </div>`;
                    
                    document.getElementById('gofile-upload-btn').addEventListener('click', () => {
                        GoFileUploader.openModal(patient);
                    });
                    
                    document.querySelectorAll('.view-file-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            window.open(e.currentTarget.dataset.url, '_blank');
                        });
                    });

                    document.querySelectorAll('.delete-file-link').forEach(link => {
                        link.addEventListener('click', async (e) => {
                            e.preventDefault();
                            const fileIndex = parseInt(e.currentTarget.dataset.index, 10);
                            const fileToDelete = patient.files[fileIndex];
                            if (!fileToDelete) return;

                            window.showConfirmModal('Delete File?', `Are you sure you want to permanently delete the file "${fileToDelete.name}"? This will also remove it from GoFile.`, async () => {
                                try {
                                    await GoFileUploader.deleteFile(fileToDelete);
                                    const updatedFiles = patient.files.filter((_, i) => i !== fileIndex);
                                    await FirestoreDB.savePatient(patient.id, { files: updatedFiles });
                                    window.showNotification('File deleted successfully.', 'success');
                                } catch (error) {
                                    console.error("Error deleting file:", error);
                                    window.showNotification(`Error deleting file: ${error.message}`, 'error');
                                }
                            });
                        });
                    });

                    document.querySelectorAll('.file-actions-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent document click from closing it immediately
                            const index = e.currentTarget.dataset.index;
                            // Close other dropdowns
                            document.querySelectorAll('[id^="file-actions-dropdown-"]').forEach(d => {
                                if (d.id !== `file-actions-dropdown-${index}`) d.classList.add('hidden');
                            });
                            // Toggle current dropdown
                            document.getElementById(`file-actions-dropdown-${index}`).classList.toggle('hidden');
                        });
                    });

                    document.querySelectorAll('.add-file-note-form').forEach(form => {
                        form.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const noteText = e.target.querySelector('textarea').value;
                            const fileIndex = parseInt(e.target.dataset.fileIndex, 10);
                            if (!noteText.trim() || isNaN(fileIndex)) return;

                            const updatedFiles = JSON.parse(JSON.stringify(patient.files || []));
                            if (!updatedFiles[fileIndex].notes) {
                                updatedFiles[fileIndex].notes = [];
                            }
                            updatedFiles[fileIndex].notes.push(noteText);
                            
                            await FirestoreDB.savePatient(patient.id, { files: updatedFiles });
                            e.target.querySelector('textarea').value = ''; // Clear textarea after saving
                        });
                    });

                } else if (tabName === 'credentials') {
                    tabContent.innerHTML = `<div class="bg-white rounded-xl shadow-lg border border-slate-200"><div class="p-4 border-b border-slate-200"><button id="add-credential-btn" class="btn bg-purple-600 hover:bg-purple-700 text-white text-sm">Add Credential</button></div><div class="divide-y divide-slate-200">${(patient.credentials || []).map(cred => `<div class="p-4"><p class="font-semibold text-slate-800">${cred.service}</p><p class="text-sm text-slate-600">Link: <a href="${cred.link}" target="_blank" class="text-primary-500 hover:underline">${cred.link}</a></p><p class="text-sm text-slate-600">Username: ${cred.username}</p><p class="text-sm text-slate-600">Password Info: <span class="font-mono bg-slate-100 p-1 rounded text-red-600">${cred.passwordRef}</span></p></div>`).join('') || '<p class="p-4 text-slate-500">No credentials saved.</p>'}</div></div>`;
                    const modal = document.getElementById('credential-modal');
                    document.getElementById('add-credential-btn').addEventListener('click', () => modal.classList.remove('hidden'));
                    document.getElementById('cancel-cred-btn').addEventListener('click', () => modal.classList.add('hidden'));
                    document.getElementById('credential-form').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; const updatedCreds = [...(patient.credentials || []), { service: form.service.value, link: form.link.value, username: form.username.value, passwordRef: form.passwordRef.value }]; await FirestoreDB.savePatient(patient.id, { credentials: updatedCreds }); modal.classList.add('hidden'); form.reset(); });
                } else if (tabName === 'links') {
                    // This re-fetches resources to ensure the latest list is available for linking
                    FirestoreDB.getResources(snapshot => {
                        const tabContentAfterFetch = document.getElementById('tab-content');
                        if (!tabContentAfterFetch) return;
                        
                        const allResources = [];
                        snapshot.forEach(doc => allResources.push({ id: doc.id, ...doc.data() }));
                        const linkedResources = (patient.linkedResourceIds || []).map(id => allResources.find(r => r.id === id)).filter(Boolean);
                        
                        tabContentAfterFetch.innerHTML = `<div class="space-y-6">
                            <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-4"><h3 class="font-semibold text-lg text-slate-800">Patient MyPage Link</h3><div class="flex gap-2 mt-2"><input type="url" id="mypage-link-input" class="input flex-grow" value="${patient.mypageLink || ''}" placeholder="https://example.com/patient-page"><button id="save-mypage-link" class="btn btn-primary text-sm">Save</button></div></div>
                            <div class="bg-white rounded-xl shadow-lg border border-slate-200"><div class="p-4 border-b border-slate-200 flex flex-wrap justify-between items-center gap-4"><h3 class="font-semibold text-lg text-slate-800">Linked Resources</h3><div class="flex gap-2"><button id="open-link-resource-modal" class="btn btn-primary text-sm">Link Existing</button><button id="create-link-resource-modal-btn" class="btn btn-secondary text-sm">Create & Link New</button></div></div><div class="divide-y divide-slate-200">${linkedResources.map(resource => `<div class="p-4 flex items-center justify-between"><div class="flex-1 min-w-0">${resource.type === 'article' ? `<p class="font-semibold text-secondary-700">${resource.title}</p><p class="text-sm text-slate-600">${resource.summary}</p><a href="${resource.link}" target="_blank" class="text-xs text-primary-500 font-medium">Read Article</a>` : `<p class="font-semibold text-secondary-700">${resource.name}</p><p class="text-sm text-slate-600">Specialty: ${resource.specialty}</p><p class="text-sm text-slate-600">Contact: ${resource.contact}</p>`}</div><button data-id="${resource.id}" class="unlink-resource-btn text-slate-400 hover:text-red-500 p-2 rounded-full"><svg class="w-5 h-5" data-lucide="unlink-2"></svg></button></div>`).join('') || '<p class="p-4 text-slate-500">No resources linked.</p>'}</div></div>
                        </div>`;
                        
                        document.getElementById('save-mypage-link').addEventListener('click', async () => { await FirestoreDB.savePatient(patient.id, { mypageLink: document.getElementById('mypage-link-input').value }); window.showNotification('Link saved!', 'success'); });
                        document.getElementById('open-link-resource-modal').addEventListener('click', () => {
                            const modal = document.getElementById('link-resource-modal');
                            document.getElementById('resource-link-list').innerHTML = allResources.map(r => `<label class="p-4 flex items-center justify-between cursor-pointer hover:bg-slate-100"><div class="pr-4"><p class="font-semibold text-slate-700">${r.title || r.name}</p><p class="text-sm text-slate-500">${r.summary || r.specialty}</p></div><input type="checkbox" value="${r.id}" class="resource-link-checkbox h-5 w-5 rounded text-primary-600 focus:ring-primary-500" ${(patient.linkedResourceIds || []).includes(r.id) ? 'checked' : ''}></label>`).join('');
                            modal.classList.remove('hidden');
                        });
                        document.getElementById('create-link-resource-modal-btn').addEventListener('click', () => {
                            ResourcesComponent.openModal(patient.id); // Pass patient ID to pre-select it
                        });
                        document.querySelectorAll('.unlink-resource-btn').forEach(btn => btn.addEventListener('click', async (e) => { const resourceId = e.currentTarget.dataset.id; await FirestoreDB.savePatient(patient.id, { linkedResourceIds: (patient.linkedResourceIds || []).filter(id => id !== resourceId) }); }));
                        document.getElementById('cancel-link-resource-btn').addEventListener('click', () => document.getElementById('link-resource-modal').classList.add('hidden'));
                        document.getElementById('save-link-resource-btn').addEventListener('click', async () => { await FirestoreDB.savePatient(patient.id, { linkedResourceIds: Array.from(document.querySelectorAll('.resource-link-checkbox:checked')).map(cb => cb.value) }); document.getElementById('link-resource-modal').classList.add('hidden'); });
                        if(window.lucide) window.lucide.createIcons();
                    });
                }
                if(window.lucide) window.lucide.createIcons();
            }
        };

        // =================================================================================
        // --- GoFile Uploader Integration ---
        const GoFileUploader = {
            selectedFile: null,
            activePatient: null,
            rootFolderId: null, // This will store the actual root folder ID for the user
            userAccountId: null, // This will store the user's GoFile account ID
            _listenersInitialized: false, // Flag to prevent re-initializing listeners

            async getRootFolderId() {
                if (this.rootFolderId) return this.rootFolderId; // If already fetched, return it

                try {
                    // Step 1: Get the account ID using the new endpoint
                    const idRes = await fetch(`https://api.gofile.io/accounts/getid?token=${GOFILE_API_KEY}`);
                    if (!idRes.ok) {
                        const errorText = await idRes.text();
                        throw new Error(`GoFile API error getting ID: ${idRes.status} ${idRes.statusText} - ${errorText}`);
                    }
                    const idData = await idRes.json();
                    if (idData.status !== 'ok' || !idData.data?.id) {
                        throw new Error(idData.data?.error || 'Could not retrieve GoFile account ID.');
                    }
                    this.userAccountId = idData.data.id; // Store the account ID

                    // Step 2: Get account details using the account ID to find the root folder
                    const detailsRes = await fetch(`https://api.gofile.io/accounts/${this.userAccountId}?token=${GOFILE_API_KEY}`);
                    if (!detailsRes.ok) {
                        const errorText = await detailsRes.text();
                        throw new Error(`GoFile API error getting details: ${detailsRes.status} ${detailsRes.statusText} - ${errorText}`);
                    }
                    const detailsData = await detailsRes.json();
                    if (detailsData.status !== 'ok' || !detailsData.data?.rootFolder) {
                        throw new Error(detailsData.data?.error || 'Could not retrieve GoFile root folder from account details.');
                    }
                    this.rootFolderId = detailsData.data.rootFolder; // Store the root folder ID
                    return this.rootFolderId;

                } catch (e) {
                    console.error("GoFile Auth Error:", e);
                    window.showNotification(`GoFile account connection error: ${e.message}. Check API Key and GoFile status.`, 'error');
                    return null;
                }
            },

            async getOrCreateFolder(parentFolderId, folderName) {
                // Try to get contents of the parent folder to check for existing subfolder
                // This GET request might fail with 401/error-notPremium for free accounts.
                // We log the warning but proceed to try creating the folder regardless.
                try {
                    const contentRes = await fetch(`https://api.gofile.io/contents/${parentFolderId}?token=${GOFILE_API_KEY}`);
                    if (contentRes.ok) {
                        const contentData = await contentRes.json();
                        if (contentData.status === 'ok' && contentData.data && contentData.data.contents) {
                            const existingFolder = Object.values(contentData.data.contents).find(c => c.type === 'folder' && c.name === folderName);
                            if (existingFolder) return existingFolder.id;
                        } else {
                            console.warn(`GoFile: Could not retrieve contents for folder ${parentFolderId}. Status: ${contentData.status}. Error: ${contentData.data?.error || 'Unknown error.'}`);
                        }
                    } else {
                        const errorText = await contentRes.text();
                        console.warn(`GoFile: Failed to GET contents of folder ${parentFolderId}. Status: ${contentRes.status}. Text: ${errorText}. This might be due to a non-premium account for this API call (expected for /contents/{id}).`);
                    }
                } catch (e) {
                    console.warn(`GoFile: Error during getContent API call for folder ${parentFolderId}:`, e.message);
                }

                // Create folder if not found or if the check failed/unauthorized.
                // This relies on GoFile's API to either create a new folder or return an error if it already exists
                // and we couldn't detect it via getContent.
                try {
                    const createRes = await fetch(`https://api.gofile.io/contents/createFolder`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${GOFILE_API_KEY}` // API token in Authorization header
                        },
                        body: JSON.stringify({ parentFolderId, folderName })
                    });
                    const createData = await createRes.json();
                    if (createData.status !== 'ok') {
                        throw new Error(createData.data?.error || 'Could not create folder in GoFile.');
                    }
                    return createData.data.id;
                } catch (e) {
                    console.error(`GoFile: Error creating folder ${folderName} in parent ${parentFolderId}:`, e.message);
                    throw e; // Re-throw to propagate the error if folder creation truly failed
                }
            },
            
            async deleteFile(file) {
                if (!file || !file.gofile || !file.gofile.fileId) {
                    throw new Error("File data is incomplete for deletion.");
                }
                // contentsId parameter expects a comma-separated list, even for a single ID
                const contentsIdToDelete = file.gofile.fileId; 

                const res = await fetch(`https://api.gofile.io/contents`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GOFILE_API_KEY}` // API token in Authorization header
                    },
                    body: JSON.stringify({ contentsId: contentsIdToDelete }) 
                });
                const data = await res.json();
                if (data.status !== 'ok') {
                    // GoFile's deleteContent might return an error if the file is already gone or permission denied.
                    // Log a warning but don't re-throw if the goal is just to remove it from the app.
                    console.warn("Could not delete file from GoFile, it may already be gone or permissions are insufficient:", data);
                    // Optionally, you might still want to throw an error if this is a critical operation
                    // throw new Error(data.data?.error || 'Failed to delete file from GoFile.');
                }
                return true;
            },

            renderModal() {
                return `
                <div id="gofile-upload-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
                    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 w-full max-w-lg mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h1 class="text-2xl font-bold text-slate-800">Upload PDF to GoFile</h1>
                            <button id="gofile-cancel-btn" class="text-slate-500 hover:text-slate-800 text-3xl font-light">&times;</button>
                        </div>
                        <div id="gofile-drop-zone" class="mt-6 border-2 border-dashed border-slate-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary-500 hover:bg-slate-50 transition-all duration-300">
                            <input type="file" id="gofile-file-input" class="hidden" accept="application/pdf">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V8.25c0-1.12.93-2.037 2.07-1.99a4.504 4.504 0 013.635-3.497c1.52-.343 3.056.343 4.135 1.595a4.504 4.504 0 013.497 3.635c.343 1.52-.343 3.056-1.595 4.135a4.504 4.504 0 01-3.635 3.497H5.07C3.93 19.287 3 18.37 3 17.25z" /></svg>
                                <p class="mt-4 text-lg text-slate-600"><span class="font-semibold text-primary-600">Click to upload</span> or drag and drop</p>
                                <p class="text-sm text-slate-500 mt-1">PDF files only</p>
                            </div>
                        </div>
                        <div id="gofile-status-section" class="mt-6 space-y-4">
                            <div id="gofile-file-info" class="hidden items-center justify-between bg-slate-100 p-3 rounded-lg">
                                <p id="gofile-file-name" class="text-sm font-medium text-slate-700 truncate"></p>
                                <button id="gofile-remove-file-btn" class="text-red-500 hover:text-red-700 font-bold">&times;</button>
                            </div>
                            <div id="gofile-error-message" class="hidden text-red-600 text-sm font-medium p-3 bg-red-50 rounded-lg text-center"></div>
                            <button id="gofile-upload-action-btn" class="w-full bg-primary-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-700 disabled:bg-slate-400 disabled:cursor-not-allowed">Upload File</button>
                            <div id="gofile-uploading-spinner" class="hidden flex items-center justify-center space-x-2 text-slate-600">
                                <svg class="animate-spin h-5 w-5 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <span>Uploading, please wait...</span>
                            </div>
                        </div>
                        <div id="gofile-result-section" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg text-center">
                            <h3 class="text-lg font-semibold text-green-800">Done!</h3>
                            <p class="text-sm text-slate-600">The file has been saved to the patient's record.</p>
                        </div>
                    </div>
                </div>`;
            },
            
            openModal(patient) {
                this.activePatient = patient;
                const modal = document.getElementById('gofile-upload-modal');
                modal.classList.remove('hidden');
                
                // Fix: Initialize listeners first, then reset UI state
                this.init(); 
                this.resetUI(); 
            },

            closeModal() {
                const modal = document.getElementById('gofile-upload-modal');
                modal.classList.add('hidden');
                this.resetUI();
            },
            
            init() {
                // Only set up event listeners once per modal instance
                if (this._listenersInitialized) return; 

                this.dropZone = document.getElementById('gofile-drop-zone');
                this.fileInput = document.getElementById('gofile-file-input');
                this.uploadBtn = document.getElementById('gofile-upload-action-btn');
                this.fileInfo = document.getElementById('gofile-file-info');
                this.fileNameEl = document.getElementById('gofile-file-name');
                this.removeFileBtn = document.getElementById('gofile-remove-file-btn');
                this.errorMessage = document.getElementById('gofile-error-message');
                this.uploadingSpinner = document.getElementById('gofile-uploading-spinner');
                this.resultSection = document.getElementById('gofile-result-section');
                this.cancelBtn = document.getElementById('gofile-cancel-btn');

                this.dropZone.addEventListener('click', () => this.fileInput.click());
                this.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); this.dropZone.classList.add('border-primary-500', 'bg-primary-50'); });
                this.dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); this.dropZone.classList.remove('border-primary-500', 'bg-primary-50'); });
                this.dropZone.addEventListener('drop', (e) => { e.preventDefault(); this.dropZone.classList.remove('border-primary-500', 'bg-primary-50'); if (e.dataTransfer.files.length) this.handleFile(e.dataTransfer.files[0]); });
                this.fileInput.addEventListener('change', (e) => { if (e.target.files.length) this.handleFile(e.target.files[0]); });
                this.removeFileBtn.addEventListener('click', () => this.resetUI());
                this.uploadBtn.addEventListener('click', () => { if (this.selectedFile) this.uploadFile(this.selectedFile); });
                this.cancelBtn.addEventListener('click', () => this.closeModal());

                // No initial call to resetUI here, as it's done in openModal now.
                this._listenersInitialized = true; // Mark listeners as initialized
            },

            resetUI() {
                // Ensure elements are initialized before trying to access their properties
                if (this.fileInput) this.fileInput.value = '';
                this.selectedFile = null;
                // Ensure elements exist before trying to access properties
                if (this.fileInfo) this.fileInfo.classList.add('hidden');
                if (this.uploadBtn) {
                    this.uploadBtn.classList.remove('hidden');
                    this.uploadBtn.disabled = true;
                }
                if (this.errorMessage) {
                    this.errorMessage.classList.add('hidden');
                    this.errorMessage.textContent = '';
                }
                if (this.uploadingSpinner) this.uploadingSpinner.classList.add('hidden');
                if (this.resultSection) this.resultSection.classList.add('hidden');
                if (this.dropZone) this.dropZone.classList.remove('border-green-500', 'bg-green-50');
            },
            
            handleFile(file) {
                if (file.type !== "application/pdf") {
                    this.showError("Please choose a PDF file.");
                    this.fileInput.value = '';
                    return;
                }
                this.selectedFile = file;
                this.fileNameEl.textContent = file.name;
                this.fileInfo.classList.remove('hidden');
                this.uploadBtn.disabled = false;
                this.errorMessage.classList.add('hidden');
            },
            
            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.classList.remove('hidden');
                this.uploadingSpinner.classList.add('hidden');
                this.uploadBtn.classList.remove('hidden');
                this.uploadBtn.disabled = true;
            },

            async uploadFile(file) {
                this.uploadBtn.classList.add('hidden');
                this.uploadingSpinner.classList.remove('hidden');
                this.errorMessage.classList.add('hidden');
                this.fileInfo.classList.add('hidden');

                try {
                    const rootFolderId = await this.getRootFolderId();
                    if (!rootFolderId) return; // Error was already shown by getRootFolderId

                    const mainAppFolderId = await this.getOrCreateFolder(rootFolderId, GOFILE_ROOT_FOLDER_NAME);
                    const userFolderId = await this.getOrCreateFolder(mainAppFolderId, userId); // userId is global from config.js

                    // *** CRITICAL FIX: Directly use the main upload endpoint as per documentation ***
                    // Removed the /serverlist API call because it's causing a 404.
                    const uploadEndpoint = `https://upload.gofile.io/uploadFile`; 

                    const formData = new FormData();
                    formData.append("file", file);
                    formData.append("token", GOFILE_API_KEY); 
                    formData.append("folderId", userFolderId);

                    const uploadRes = await fetch(uploadEndpoint, { 
                        method: "POST", 
                        body: formData
                    });

                    const uploadData = await uploadRes.json();
                    console.log('GoFile Upload Success Response:', uploadData); // <-- IMPORTANT: Check this log for structure!

                    if (uploadData.status !== 'ok') {
                        throw new Error(uploadData.data?.error || 'File upload failed.');
                    }

                    // Save to Firestore with GoFile details for deletion and retrieval
                    // Explicitly set properties to null if they are undefined or missing from response
                    const newFile = { 
                        name: file.name, 
                        url: uploadData.data?.downloadPage || null, // Safeguard against undefined or missing property
                        storage: 'gofile',
                        gofile: {
                            fileId: uploadData.data?.fileId || null,     // Safeguard against undefined or missing property
                            adminCode: uploadData.data?.adminCode || null // Safeguard against undefined or missing property
                        },
                        notes: []
                    };
                    const updatedFiles = [...(this.activePatient.files || []), newFile];
                    await FirestoreDB.savePatient(this.activePatient.id, { files: updatedFiles });

                    this.uploadingSpinner.classList.add('hidden');
                    this.resultSection.classList.remove('hidden');
                    window.showNotification('File uploaded successfully!', 'success'); // Added success notification

                } catch (error) {
                    console.error("GoFile Upload Error:", error);
                    this.showError(error.message || "An unexpected error occurred during upload.");
                    this.fileInfo.classList.remove('hidden'); 
                }
            }
        };

        // =================================================================================
        // --- App Initialization ---
        function initializeAndStartApp() {
            try {
                // Initialize Firebase
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                // Initialize Router and add routes
                AppRouter.init();
                AppRouter.addRoute('/', LoginComponent);
                AppRouter.addRoute('/dashboard', DashboardComponent);
                AppRouter.addRoute('/patients', PatientsComponent);
                AppRouter.addRoute('/patient/:id', PatientDetailComponent);
                AppRouter.addRoute('/resources', ResourcesComponent);
                
                // Listen for Firebase Auth state changes
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        userId = user.uid; // Set the global userId
                        const currentPath = window.location.hash.slice(1);
                        // If logged in, navigate to dashboard or current hash if valid
                        if (!currentPath || currentPath === '/') {
                            AppRouter.navigate('/dashboard');
                        } else {
                            AppRouter.handleRouteChange(); // Re-evaluate the current hash
                        }
                    } else {
                        // If logged out, clear userId and navigate to login
                        userId = null;
                        AppRouter.navigate('/');
                        AppRouter.handleRouteChange();
                    }
                });

                // Global event listener to close file action dropdowns when clicking outside
                window.addEventListener('click', function(e) {    
                    document.querySelectorAll('[id^="file-actions-dropdown-"]').forEach(dropdown => {
                        if (!dropdown.contains(e.target) && !e.target.closest('.file-actions-btn')) {
                            dropdown.classList.add('hidden');
                        }
                    });
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                // Display a critical error message if Firebase fails to initialize
                document.getElementById('app').innerHTML = `<div class="min-h-screen flex items-center justify-center bg-red-50"><div class="text-center p-8 bg-white rounded-lg shadow-lg"><h2 class="text-2xl font-bold text-red-700">Error: Application Initialization Failed</h2><p class="mt-2 text-slate-600">The application could not start. Please check console for details and ensure all dependencies are loaded correctly.</p><p class="mt-4 text-sm text-slate-500">Details: ${e.message}</p></div></div>`;
            }
        }

        // --- Start the App ---
        initializeAndStartApp();
    </script>
</body>
</html>