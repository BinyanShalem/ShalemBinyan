<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refuah Berurah - Production Ready</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.292.0/dist/lucide-react.min.js"></script>
    
    <!-- Firebase SDKs (Classic Scripts) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .input { margin-top: 0.25rem; display: block; width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .input:focus { outline: none; --tw-ring-color: #3B82F6; box-shadow: 0 0 0 2px var(--tw-ring-color); border-color: #3B82F6; }
        .loader { width: 48px; height: 48px; border: 5px solid #d1d5db; border-bottom-color: #3B82F6; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-overlay { position: absolute; inset: 0; background-color: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10; }
        #initial-loader { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div id="initial-loader">
            <div class="text-center">
                <h1 class="text-2xl font-bold text-blue-600">Refuah Berurah</h1>
                <p class="mt-2 text-gray-600">Connecting to services...</p>
            </div>
        </div>
    </div>
    <div id="modal-container">
        <!-- Modals will be rendered here -->
    </div>

    <script>
        // =================================================================================
        // Firebase Configuration - This is now correctly filled in.
        // =================================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyDMAZ_HJ7JIqNHxYAXcOgpVZN4tnLwWUWA",
          authDomain: "refuahberur.firebaseapp.com",
          projectId: "refuahberur",
          storageBucket: "refuahberur.appspot.com",
          messagingSenderId: "345766239268",
          appId: "1:345766239268:web:9b7fcf947760b5ea53ccb1",
          measurementId: "G-0XREW3ZGYZ"
        };
        // =================================================================================

        // --- App State ---
        let app, auth, db, userId;
        const appId = 'refuah-berurah-prod';

        // --- ROUTER: Handles navigation within the single-page application ---
        const AppRouter = {
            routes: {},
            currentRoute: '',
            init() {
                window.addEventListener('hashchange', () => this.handleRouteChange());
                window.addEventListener('load', () => this.handleRouteChange());
            },
            addRoute(route, component) { this.routes[route] = component; },
            handleRouteChange() {
                const hash = window.location.hash.slice(1) || '/';
                if (this.currentRoute === hash && hash !== '/') return;

                const routeParts = hash.split('/');
                let component;
                let params = {};
                
                if (routeParts[1] === 'patient' && routeParts.length === 3) {
                    component = this.routes['/patient/:id'];
                    params = { id: routeParts[2] };
                } else {
                    component = this.routes[hash];
                }

                if (component) {
                    this.currentRoute = hash;
                    document.getElementById('app').innerHTML = component.render(params);
                    document.getElementById('modal-container').innerHTML = component.renderModals ? component.renderModals() : '';
                    if (component.postRender) component.postRender(params);
                } else {
                    window.location.hash = '/';
                }
            },
            navigate(path) { window.location.hash = path; }
        };

        // --- Firestore Database Layer ---
        const FirestoreDB = {
            getPatients: (callback) => db.collection(`artifacts/${appId}/users/${userId}/patients`).onSnapshot(callback),
            addPatient: (patientData) => db.collection(`artifacts/${appId}/users/${userId}/patients`).add(patientData),
            savePatient: (patientId, patientData) => db.collection(`artifacts/${appId}/users/${userId}/patients`).doc(patientId).set(patientData, { merge: true }),
            deletePatient: (patientId) => db.collection(`artifacts/${appId}/users/${userId}/patients`).doc(patientId).delete(),
            getResources: (callback) => db.collection(`artifacts/${appId}/users/${userId}/resources`).onSnapshot(callback),
            addResource: (resourceData) => db.collection(`artifacts/${appId}/users/${userId}/resources`).add(resourceData),
            deleteResource: (resourceId) => db.collection(`artifacts/${appId}/users/${userId}/resources`).doc(resourceId).delete(),
        };

        // --- GLOBAL MODAL HELPER ---
        window.showConfirmModal = (title, message, onConfirm) => {
            const modal = document.getElementById('confirm-modal');
            if (!modal) return;
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerText = message;
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.onclick = () => { onConfirm(); modal.classList.add('hidden'); };
            document.getElementById('cancel-confirm-btn').onclick = () => { modal.classList.add('hidden'); };
            modal.classList.remove('hidden');
            if (window.lucide) window.lucide.createIcons({ nodes: [modal.querySelector('[data-lucide]')] });
        };

        // --- COMPONENTS ---

        const Layout = {
            render(content, activeLink) {
                const navLinks = [
                    { path: '/dashboard', icon: 'LayoutDashboard', label: 'Dashboard' },
                    { path: '/patients', icon: 'Users', label: 'Patients' },
                    { path: '/resources', icon: 'BookMarked', label: 'Resources' },
                ];
                return `
                    <div class="min-h-screen flex">
                        <nav class="w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col">
                            <div class="h-16 flex items-center justify-center border-b border-gray-200"><h1 class="text-2xl font-bold text-blue-600">Refuah Berurah</h1></div>
                            <div class="p-4 flex-grow"><ul>
                                ${navLinks.map(link => `<li><a href="#${link.path}" class="flex items-center p-3 rounded-lg text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-all ${activeLink === link.label ? 'bg-blue-100 text-blue-700 font-semibold' : ''}"><svg class="w-5 h-5 mr-3" data-lucide="${link.icon.toLowerCase()}"></svg>${link.label}</a></li>`).join('')}
                            </ul></div>
                            <div class="p-4 border-t border-gray-200"><a href="#" id="logout-btn" class="flex items-center p-3 rounded-lg text-gray-600 hover:bg-red-50 hover:text-red-600 transition-all"><svg class="w-5 h-5 mr-3" data-lucide="log-out"></svg>Logout</a></div>
                        </nav>
                        <main class="flex-1 bg-gray-50 p-6 sm:p-8 overflow-y-auto relative">${content}</main>
                    </div>
                    ${this.renderConfirmModal()}
                `;
            },
            renderConfirmModal() {
                return `
                    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" data-lucide="alert-triangle"></svg></div>
                            <h3 id="confirm-title" class="text-lg font-bold mt-3">Delete Item</h3>
                            <p id="confirm-message" class="text-sm text-gray-500 mt-2 mb-4">Are you sure? This action cannot be undone.</p>
                            <div class="flex justify-center space-x-3">
                                <button id="cancel-confirm-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 w-24">Cancel</button>
                                <button id="confirm-action-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 w-24">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            },
            postRender() {
                if (window.lucide) window.lucide.createIcons();
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await auth.signOut(); AppRouter.navigate('/'); });
            }
        };

        const LoginComponent = {
            render() {
                return `
                    <div class="min-h-screen flex items-center justify-center bg-gray-100">
                        <div class="w-full max-w-md">
                            <div id="auth-container" class="bg-white rounded-xl shadow-lg p-8 space-y-6">
                                <!-- Login/Signup forms will be rendered here -->
                            </div>
                        </div>
                    </div>
                `;
            },
            renderLoginForm(error = '') {
                return `
                    <div class="text-center">
                        <h1 class="text-3xl font-bold text-blue-600">Refuah Berurah</h1>
                        <p class="mt-2 text-gray-500">Sign in to your secure medical hub</p>
                    </div>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700">Email address</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required class="input">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="input">
                        </div>
                        ${error ? `<p class="text-sm text-red-600">${error}</p>` : ''}
                        <div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                Sign in
                            </button>
                        </div>
                    </form>
                    <p class="text-center text-sm text-gray-500">
                        No account? <a href="#" id="show-signup" class="font-medium text-blue-600 hover:text-blue-500">Create one</a>
                    </p>
                `;
            },
            renderSignupForm(error = '') {
                 return `
                    <div class="text-center">
                        <h1 class="text-3xl font-bold text-blue-600">Create Account</h1>
                        <p class="mt-2 text-gray-500">Get started with your secure hub</p>
                    </div>
                    <form id="signup-form" class="space-y-4">
                        <div>
                            <label for="signup-email" class="block text-sm font-medium text-gray-700">Email address</label>
                            <input id="signup-email" name="email" type="email" autocomplete="email" required class="input">
                        </div>
                        <div>
                            <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input id="signup-password" name="password" type="password" autocomplete="new-password" required class="input">
                        </div>
                         ${error ? `<p class="text-sm text-red-600">${error}</p>` : ''}
                        <div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                Create Account
                            </button>
                        </div>
                    </form>
                    <p class="text-center text-sm text-gray-500">
                        Already have an account? <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-500">Sign in</a>
                    </p>
                `;
            },
            postRender() {
                const authContainer = document.getElementById('auth-container');
                
                const showLogin = (error = '') => {
                    authContainer.innerHTML = this.renderLoginForm(error);
                    document.getElementById('login-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const email = e.target.email.value;
                        const password = e.target.password.value;
                        try {
                            await auth.signInWithEmailAndPassword(email, password);
                        } catch (err) {
                            showLogin(err.message);
                        }
                    });
                    document.getElementById('show-signup').addEventListener('click', (e) => {
                        e.preventDefault();
                        showSignup();
                    });
                };

                const showSignup = (error = '') => {
                    authContainer.innerHTML = this.renderSignupForm(error);
                    document.getElementById('signup-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const email = e.target.email.value;
                        const password = e.target.password.value;
                        try {
                            await auth.createUserWithEmailAndPassword(email, password);
                        } catch (err) {
                            showSignup(err.message);
                        }
                    });
                     document.getElementById('show-login').addEventListener('click', (e) => {
                        e.preventDefault();
                        showLogin();
                    });
                };

                showLogin();
            }
        };

        const DashboardComponent = {
            render() { return Layout.render(`<div id="dashboard-content"><div class="loading-overlay"><div class="loader"></div></div></div>`, 'Dashboard'); },
            async postRender() {
                Layout.postRender();
                FirestoreDB.getPatients(patientQuerySnapshot => {
                    const patientCount = patientQuerySnapshot.size;
                    const countEl = document.querySelector('#patient-count');
                    if (countEl) countEl.innerText = patientCount;
                });

                FirestoreDB.getResources(resourceQuerySnapshot => {
                    const resourceCount = resourceQuerySnapshot.size;
                    const countEl = document.querySelector('#resource-count');
                    if(countEl) countEl.innerText = resourceCount;
                });

                document.getElementById('dashboard-content').innerHTML = `
                    <div class="space-y-8">
                        <div><h2 class="text-3xl font-bold text-gray-800">Dashboard</h2><p class="mt-1 text-gray-500">Welcome back! Here's a real-time summary of your workspace.</p></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex items-center"><div class="p-3 rounded-full bg-blue-100 text-blue-600"><svg class="w-6 h-6" data-lucide="users"></svg></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">Total Patients</p><p id="patient-count" class="text-2xl font-bold text-gray-800">0</p></div></div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex items-center"><div class="p-3 rounded-full bg-green-100 text-green-600"><svg class="w-6 h-6" data-lucide="book-marked"></svg></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">Total Resources</p><p id="resource-count" class="text-2xl font-bold text-gray-800">0</p></div></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">Quick Actions</h3>
                            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <a href="#/patients" class="flex items-center justify-center p-4 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-all"><svg class="w-5 h-5 mr-2" data-lucide="user-plus"></svg>Add New Patient</a>
                                <a href="#/resources" class="flex items-center justify-center p-4 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-all"><svg class="w-5 h-5 mr-2" data-lucide="plus-circle"></svg>Add New Resource</a>
                            </div>
                        </div>
                    </div>`;
                if(window.lucide) window.lucide.createIcons();
            }
        };

        const PatientsComponent = {
            render() { return Layout.render(`<div id="patients-container"><div class="loading-overlay"><div class="loader"></div></div></div>`, 'Patients'); },
            renderModals() {
                return `
                    <div id="patient-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg"><h3 class="text-2xl font-bold mb-4">Add New Patient</h3><form id="patient-form" class="space-y-4">
                            <div><label for="name" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="name" required class="input"></div>
                            <div><label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth</label><input type="date" id="dob" required class="input"></div>
                            <div><label for="contact" class="block text-sm font-medium text-gray-700">Contact Info</label><input type="text" id="contact" required class="input"></div>
                            <div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-patient-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save Patient</button></div>
                        </form></div>
                    </div>`;
            },
            postRender() {
                Layout.postRender();
                const container = document.getElementById('patients-container');
                FirestoreDB.getPatients(querySnapshot => {
                    container.innerHTML = `
                        <div class="space-y-6">
                            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                                <div><h2 class="text-3xl font-bold text-gray-800">Patients</h2><p class="mt-1 text-gray-500">Manage your patient records.</p></div>
                                <button id="add-patient-btn" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 transition-all w-full sm:w-auto"><svg class="w-5 h-5 mr-2" data-lucide="user-plus"></svg>Add Patient</button>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-4 border-b"><input id="search-patient" type="text" placeholder="Search patients by name..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                                <div id="patient-list" class="divide-y divide-gray-200"></div>
                            </div>
                        </div>`;
                    
                    this.renderPatientList(querySnapshot.docs);
                    
                    const modal = document.getElementById('patient-modal');
                    const form = document.getElementById('patient-form');
                    document.getElementById('add-patient-btn').addEventListener('click', () => modal.classList.remove('hidden'));
                    document.getElementById('cancel-patient-btn').addEventListener('click', () => modal.classList.add('hidden'));
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await FirestoreDB.addPatient({ name: form.name.value, dob: form.dob.value, contact: form.contact.value, mypageLink: '', linkedResourceIds: [] });
                        modal.classList.add('hidden');
                        form.reset();
                    });
                    document.getElementById('search-patient').addEventListener('input', (e) => this.renderPatientList(querySnapshot.docs, e.target.value));
                    if(window.lucide) window.lucide.createIcons();
                });
            },
            renderPatientList(patients, filter = '') {
                const filteredPatients = patients.filter(p => p.data().name.toLowerCase().includes(filter.toLowerCase()));
                const listEl = document.getElementById('patient-list');
                if (!listEl) return;
                listEl.innerHTML = filteredPatients.length === 0 ? `<p class="p-6 text-center text-gray-500">No patients found.</p>` : filteredPatients.map(doc => {
                    const patient = doc.data();
                    return `<div class="p-4 flex items-center justify-between hover:bg-gray-50">
                        <a href="#/patient/${doc.id}" class="flex-1 min-w-0"><p class="font-semibold text-blue-600 truncate">${patient.name}</p><p class="text-sm text-gray-500">DOB: ${patient.dob} | Contact: ${patient.contact}</p></a>
                        <button data-id="${doc.id}" data-name="${patient.name}" class="delete-patient-btn text-gray-400 hover:text-red-500 p-2 rounded-full flex-shrink-0 ml-4"><svg class="w-5 h-5" data-lucide="trash-2"></svg></button>
                    </div>`
                }).join('');
                document.querySelectorAll('.delete-patient-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const patientId = btn.dataset.id;
                    const patientName = btn.dataset.name;
                    window.showConfirmModal('Delete Patient?', `Are you sure you want to permanently delete ${patientName}? This action cannot be undone.`, () => FirestoreDB.deletePatient(patientId));
                }));
                if (window.lucide) window.lucide.createIcons();
            },
        };

        const PatientDetailComponent = {
            render() { return Layout.render(`<div id="patient-detail-container"><div class="loading-overlay"><div class="loader"></div></div></div>`, 'Patients'); },
            renderModals() {
                return `
                    <div id="credential-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg"><h3 class="text-2xl font-bold mb-4">Add Credential</h3><form id="credential-form" class="space-y-4">
                            <div><label for="service" class="block text-sm font-medium text-gray-700">Service/System Name</label><input type="text" id="service" required class="input"></div>
                            <div><label for="link" class="block text-sm font-medium text-gray-700">URL/Link</label><input type="url" id="link" required class="input"></div>
                            <div><label for="username" class="block text-sm font-medium text-gray-700">Username</label><input type="text" id="username" required class="input"></div>
                            <div><label for="passwordRef" class="block text-sm font-medium text-gray-700">Password Location</label><input type="text" id="passwordRef" placeholder="e.g., Stored in 1Password" required class="input"></div>
                            <p class="text-xs text-red-600">Reminder: Do not store actual passwords here.</p>
                            <div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-cred-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Save</button></div>
                        </form></div>
                    </div>
                    <div id="link-resource-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl flex flex-col"><h3 class="text-2xl font-bold mb-4">Link Resources</h3>
                            <div id="resource-link-list" class="flex-grow overflow-y-auto border-t border-b mb-4 divide-y"></div>
                            <div class="flex justify-end space-x-3"><button type="button" id="cancel-link-resource-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button><button type="button" id="save-link-resource-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save Links</button></div>
                        </div>
                    </div>`;
            },
            postRender(params) {
                Layout.postRender();
                const container = document.getElementById('patient-detail-container');
                
                db.collection(`artifacts/${appId}/users/${userId}/patients`).doc(params.id).onSnapshot((patientDoc) => {
                    if (!patientDoc.exists) {
                        container.innerHTML = `<p>Patient not found.</p>`;
                        return;
                    }
                    const patient = { id: patientDoc.id, ...patientDoc.data() };
                    
                    container.innerHTML = `
                        <div class="space-y-8">
                            <div>
                                <a href="#/patients" class="flex items-center text-sm text-blue-600 hover:underline mb-4"><svg class="w-4 h-4 mr-1" data-lucide="arrow-left"></svg>Back to Patients</a>
                                <h2 class="text-3xl font-bold text-gray-800">${patient.name}</h2>
                                <p class="mt-1 text-gray-500">DOB: ${patient.dob} | Contact: ${patient.contact}</p>
                            </div>
                            <div class="border-b border-gray-200"><nav class="-mb-px flex space-x-8" id="patient-tabs">
                                <a href="#" data-tab="notes" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Notes</a>
                                <a href="#" data-tab="files" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Files</a>
                                <a href="#" data-tab="credentials" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Chart Links & Credentials</a>
                                <a href="#" data-tab="links" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Links & Resources</a>
                            </nav></div>
                            <div id="tab-content"></div>
                        </div>`;
                    
                    this.switchTab('notes', patient);
                    document.querySelectorAll('.tab-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); this.switchTab(e.target.dataset.tab, patient); }));
                    if(window.lucide) window.lucide.createIcons();
                });
            },
            switchTab(tabName, patient) {
                const tabContent = document.getElementById('tab-content');
                document.querySelectorAll('.tab-link').forEach(link => {
                    const isSelected = link.dataset.tab === tabName;
                    link.classList.toggle('border-blue-500', isSelected);
                    link.classList.toggle('text-blue-600', isSelected);
                    link.classList.toggle('border-transparent', !isSelected);
                    link.classList.toggle('text-gray-500', !isSelected);
                });

                if (tabName === 'notes') {
                    tabContent.innerHTML = `<div class="bg-white rounded-lg shadow-sm border border-gray-200"><div class="p-4"><form id="note-form"><textarea id="note-text" placeholder="Add a new note..." required class="w-full p-2 border border-gray-300 rounded-md"></textarea><button type="submit" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">Add Note</button></form></div><div class="divide-y divide-gray-200">${(patient.notes || []).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(note => `<div class="p-4"><p class="text-gray-800">${note.text.replace(/\n/g, '<br>')}</p><p class="text-xs text-gray-400 mt-2">${new Date(note.timestamp).toLocaleString()}</p></div>`).join('') || '<p class="p-4 text-gray-500">No notes yet.</p>'}</div></div>`;
                    document.getElementById('note-form').addEventListener('submit', async (e) => { e.preventDefault(); const textEl = document.getElementById('note-text'); if (textEl.value.trim()) { const updatedNotes = [...(patient.notes || []), { text: textEl.value, timestamp: new Date().toISOString() }]; await FirestoreDB.savePatient(patient.id, { notes: updatedNotes }); } });
                } else if (tabName === 'files') {
                    tabContent.innerHTML = `<div class="bg-white rounded-lg shadow-sm border border-gray-200"><div class="p-4 border-b"><label for="file-upload" class="cursor-pointer inline-block bg-green-600 text-white px-4 py-2 rounded-lg text-sm"><span>Upload File</span><input id="file-upload" type="file" class="hidden"></label><p class="text-xs text-gray-500 mt-2">File uploads are simulated. In production, this would upload to a secure storage bucket.</p></div><div class="divide-y divide-gray-200">${(patient.files || []).map(file => `<div class="p-4 flex items-center"><svg class="w-6 h-6 text-gray-500 mr-3" data-lucide="file-text"></svg><div><p class="font-medium text-gray-800">${file.name}</p><p class="text-sm text-gray-500">${file.size}</p></div></div>`).join('') || '<p class="p-4 text-gray-500">No files uploaded.</p>'}</div></div>`;
                    document.getElementById('file-upload').addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) { const updatedFiles = [...(patient.files || []), { name: file.name, size: `${(file.size / 1024).toFixed(1)} KB` }]; await FirestoreDB.savePatient(patient.id, { files: updatedFiles }); } });
                } else if (tabName === 'credentials') {
                    tabContent.innerHTML = `<div class="bg-white rounded-lg shadow-sm border border-gray-200"><div class="p-4 border-b"><button id="add-credential-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">Add Credential</button></div><div class="divide-y divide-gray-200">${(patient.credentials || []).map(cred => `<div class="p-4"><p class="font-semibold text-gray-800">${cred.service}</p><p class="text-sm text-gray-600">Link: <a href="${cred.link}" target="_blank" class="text-blue-500 hover:underline">${cred.link}</a></p><p class="text-sm text-gray-600">Username: ${cred.username}</p><p class="text-sm text-gray-600">Password Info: <span class="font-mono bg-gray-100 p-1 rounded text-red-600">${cred.passwordRef}</span></p></div>`).join('') || '<p class="p-4 text-gray-500">No credentials saved.</p>'}</div></div>`;
                    const modal = document.getElementById('credential-modal');
                    document.getElementById('add-credential-btn').addEventListener('click', () => modal.classList.remove('hidden'));
                    document.getElementById('cancel-cred-btn').addEventListener('click', () => modal.classList.add('hidden'));
                    document.getElementById('credential-form').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; const updatedCreds = [...(patient.credentials || []), { service: form.service.value, link: form.link.value, username: form.username.value, passwordRef: form.passwordRef.value }]; await FirestoreDB.savePatient(patient.id, { credentials: updatedCreds }); modal.classList.add('hidden'); form.reset(); });
                } else if (tabName === 'links') {
                    FirestoreDB.getResources(snapshot => {
                        const allResources = [];
                        snapshot.forEach(doc => allResources.push({ id: doc.id, ...doc.data() }));
                        const linkedResources = (patient.linkedResourceIds || []).map(id => allResources.find(r => r.id === id)).filter(Boolean);
                        
                        tabContent.innerHTML = `<div class="space-y-6">
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4"><h3 class="font-semibold text-lg">Patient MyPage Link</h3><div class="flex gap-2 mt-2"><input type="url" id="mypage-link-input" class="input flex-grow" value="${patient.mypageLink || ''}" placeholder="https://example.com/patient-page"><button id="save-mypage-link" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">Save</button></div></div>
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200"><div class="p-4 border-b flex justify-between items-center"><h3 class="font-semibold text-lg">Linked Resources</h3><button id="open-link-resource-modal" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm">Link New Resource</button></div><div class="divide-y divide-gray-200">${linkedResources.map(resource => `<div class="p-4 flex items-center justify-between"><div class="flex-1 min-w-0">${resource.type === 'article' ? `<p class="font-semibold text-green-700">${resource.title}</p><p class="text-sm text-gray-600">${resource.summary}</p><a href="${resource.link}" target="_blank" class="text-xs text-blue-500">Read Article</a>` : `<p class="font-semibold text-green-700">${resource.name}</p><p class="text-sm text-gray-600">Specialty: ${resource.specialty}</p><p class="text-sm text-gray-600">Contact: ${resource.contact}</p>`}</div><button data-id="${resource.id}" class="unlink-resource-btn text-gray-400 hover:text-red-500 p-2 rounded-full"><svg class="w-5 h-5" data-lucide="unlink-2"></svg></button></div>`).join('') || '<p class="p-4 text-gray-500">No resources linked.</p>'}</div></div>
                        </div>`;
                        
                        document.getElementById('save-mypage-link').addEventListener('click', async () => { await FirestoreDB.savePatient(patient.id, { mypageLink: document.getElementById('mypage-link-input').value }); alert('Link saved!'); });
                        document.getElementById('open-link-resource-modal').addEventListener('click', () => {
                            const modal = document.getElementById('link-resource-modal');
                            document.getElementById('resource-link-list').innerHTML = allResources.map(r => `<label class="p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50"><div><p class="font-semibold">${r.title || r.name}</p><p class="text-sm text-gray-500">${r.summary || r.specialty}</p></div><input type="checkbox" value="${r.id}" class="resource-link-checkbox h-5 w-5 rounded" ${(patient.linkedResourceIds || []).includes(r.id) ? 'checked' : ''}></label>`).join('');
                            modal.classList.remove('hidden');
                        });
                        document.querySelectorAll('.unlink-resource-btn').forEach(btn => btn.addEventListener('click', async (e) => { const resourceId = e.currentTarget.dataset.id; await FirestoreDB.savePatient(patient.id, { linkedResourceIds: (patient.linkedResourceIds || []).filter(id => id !== resourceId) }); }));
                        document.getElementById('cancel-link-resource-btn').addEventListener('click', () => document.getElementById('link-resource-modal').classList.add('hidden'));
                        document.getElementById('save-link-resource-btn').addEventListener('click', async () => { await FirestoreDB.savePatient(patient.id, { linkedResourceIds: Array.from(document.querySelectorAll('.resource-link-checkbox:checked')).map(cb => cb.value) }); document.getElementById('link-resource-modal').classList.add('hidden'); });
                        if(window.lucide) window.lucide.createIcons();
                    });
                }
                if(window.lucide) window.lucide.createIcons();
            }
        };

        const ResourcesComponent = {
            render() { return Layout.render(`<div id="resources-container"><div class="loading-overlay"><div class="loader"></div></div></div>`, 'Resources'); },
            renderModals() {
                return `
                    <div id="resource-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg"><h3 class="text-2xl font-bold mb-4">Add New Resource</h3><form id="resource-form" class="space-y-4">
                            <div><label for="type" class="block text-sm font-medium text-gray-700">Resource Type</label><select id="type" class="input mt-1"><option value="article">Article</option><option value="doctor">Doctor</option></select></div>
                            <div id="form-fields" class="space-y-4"></div>
                            <div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancel-resource-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancel</button><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg">Save Resource</button></div>
                        </form></div>
                    </div>`;
            },
            postRender() {
                Layout.postRender();
                const container = document.getElementById('resources-container');
                FirestoreDB.getResources(querySnapshot => {
                    container.innerHTML = `
                        <div class="space-y-6">
                            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                                <div><h2 class="text-3xl font-bold text-gray-800">Resources</h2><p class="mt-1 text-gray-500">A general database for articles, doctors, and more.</p></div>
                                <button id="add-resource-btn" class="flex items-center bg-green-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-green-700 transition-all w-full sm:w-auto"><svg class="w-5 h-5 mr-2" data-lucide="plus-circle"></svg>Add Resource</button>
                            </div>
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-4 border-b"><input id="search-resource" type="text" placeholder="Search resources..." class="w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                                <div id="resource-list" class="divide-y divide-gray-200"></div>
                            </div>
                        </div>`;
                    
                    this.renderResourceList(querySnapshot.docs);
                    
                    const modal = document.getElementById('resource-modal');
                    const form = document.getElementById('resource-form');
                    const typeSelect = document.getElementById('type');
                    const formFields = document.getElementById('form-fields');
                    const getFormFields = (type) => {
                        if (type === 'article') return `<div><label for="title" class="block text-sm">Title</label><input type="text" id="title" required class="input"></div><div><label for="link" class="block text-sm">Link</label><input type="url" id="link" required class="input"></div><div><label for="summary" class="block text-sm">Summary</label><textarea id="summary" class="input"></textarea></div>`;
                        if (type === 'doctor') return `<div><label for="name" class="block text-sm">Doctor's Name</label><input type="text" id="name" required class="input"></div><div><label for="specialty" class="block text-sm">Specialty</label><input type="text" id="specialty" required class="input"></div><div><label for="contact" class="block text-sm">Contact Info</label><input type="text" id="contact" required class="input"></div>`;
                        return '';
                    };
                    const updateFormFields = () => { formFields.innerHTML = getFormFields(typeSelect.value); };
                    typeSelect.addEventListener('change', updateFormFields);
                    updateFormFields();

                    document.getElementById('add-resource-btn').addEventListener('click', () => modal.classList.remove('hidden'));
                    document.getElementById('cancel-resource-btn').addEventListener('click', () => modal.classList.add('hidden'));
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const type = typeSelect.value;
                        let resourceData = { type };
                        if (type === 'article') resourceData = { ...resourceData, title: form.title.value, link: form.link.value, summary: form.summary.value };
                        if (type === 'doctor') resourceData = { ...resourceData, name: form.name.value, specialty: form.specialty.value, contact: form.contact.value };
                        await FirestoreDB.addResource(resourceData);
                        modal.classList.add('hidden');
                        form.reset();
                        updateFormFields();
                    });
                    document.getElementById('search-resource').addEventListener('input', (e) => this.renderResourceList(querySnapshot.docs, e.target.value));
                    if(window.lucide) window.lucide.createIcons();
                });
            },
            renderResourceList(resources, filter = '') {
                const filteredResources = resources.filter(doc => JSON.stringify(doc.data()).toLowerCase().includes(filter.toLowerCase()));
                const listEl = document.getElementById('resource-list');
                if (!listEl) return;
                listEl.innerHTML = filteredResources.length === 0 ? `<p class="p-6 text-center text-gray-500">No resources found.</p>` : filteredResources.map(doc => {
                    const resource = doc.data();
                    const content = resource.type === 'article' ? `<p class="font-semibold text-green-700">${resource.title}</p><p class="text-sm text-gray-600">${resource.summary}</p><a href="${resource.link}" target="_blank" class="text-xs text-blue-500">Read Article</a>` : `<p class="font-semibold text-green-700">${resource.name}</p><p class="text-sm text-gray-600">Specialty: ${resource.specialty}</p><p class="text-sm text-gray-600">Contact: ${resource.contact}</p>`;
                    return `<div class="p-4 flex items-center justify-between hover:bg-gray-50"><div class="flex-1 min-w-0">${content}</div><button data-id="${doc.id}" data-name="${resource.title || resource.name}" class="delete-resource-btn text-gray-400 hover:text-red-500 p-2 rounded-full"><svg class="w-5 h-5" data-lucide="trash-2"></svg></button></div>`;
                }).join('');
                document.querySelectorAll('.delete-resource-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.showConfirmModal('Delete Resource?', `Are you sure you want to delete "${btn.dataset.name}"?`, () => FirestoreDB.deleteResource(btn.dataset.id));
                }));
                if(window.lucide) window.lucide.createIcons();
            },
        };

        // --- App Initialization ---
        function initializeAndStartApp() {
            try {
                // The hardcoded firebaseConfig from Step 1 is used here.
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                // --- AUTHENTICATION & ROUTING ---
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        userId = user.uid;
                        const currentPath = window.location.hash.slice(1);
                        if (!currentPath || currentPath === '/') {
                            AppRouter.navigate('/dashboard');
                        } else {
                            AppRouter.handleRouteChange();
                        }
                    } else {
                        AppRouter.navigate('/');
                        AppRouter.handleRouteChange();
                    }
                });

                AppRouter.addRoute('/', LoginComponent);
                AppRouter.addRoute('/dashboard', DashboardComponent);
                AppRouter.addRoute('/patients', PatientsComponent);
                AppRouter.addRoute('/patient/:id', PatientDetailComponent);
                AppRouter.addRoute('/resources', ResourcesComponent);
                // Initial call to render based on current hash
                AppRouter.handleRouteChange();

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('app').innerHTML = `<div class="min-h-screen flex items-center justify-center bg-red-50"><div class="text-center p-8 bg-white rounded-lg shadow-lg"><h2 class="text-2xl font-bold text-red-700">Error: Firebase Initialization Failed</h2><p class="mt-2 text-gray-600">The application could not connect to the database. Please check your Firebase configuration values.</p><p class="mt-4 text-sm text-gray-500">Details: ${e.message}</p></div></div>`;
            }
        }

        // --- Start the App ---
        initializeAndStartApp();

    </script>
</body>
</html>
